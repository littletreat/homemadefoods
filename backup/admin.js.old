/**
 * Admin Dashboard - Main JavaScript
 */

let orderService;
let allOrders = [];
let displayedOrders = [];
let currentSortBy = 'timestamp'; // 'timestamp' or 'deliveryTime'

// Initialize on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Load config to get web app URL
        const config = await loadConfig();
        
        if (config && config.googleSheets && config.googleSheets.webAppUrl) {
            orderService = new OrderService(config.googleSheets.webAppUrl);
            
            // Initial load
            await loadOrders();
            
            // Setup event listeners
            setupEventListeners();
        } else {
            showError('Configuration not found. Please check config.json');
        }
    } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize dashboard');
    }
});

/**
 * Load configuration from config.json
 */
async function loadConfig() {
    try {
        const response = await fetch('config.json');
        return await response.json();
    } catch (error) {
        console.error('Error loading config:', error);
        throw error;
    }
}

/**
 * Setup event listeners
 */
function setupEventListeners() {
    // Refresh button
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
            refreshBtn.disabled = true;
            await loadOrders();
            refreshBtn.disabled = false;
        });
    }
    
    // Search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            handleSearch(e.target.value);
        });
    }
    
    // Sort select
    const sortSelect = document.getElementById('sortSelect');
    if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
            currentSortBy = e.target.value;
            handleSort();
        });
    }
    
    // Status filter
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', (e) => {
            handleStatusFilter(e.target.value);
        });
    }
}

/**
 * Load orders from Google Sheets
 */
async function loadOrders() {
    try {
        showLoading();
        
        // Fetch orders
        allOrders = await orderService.fetchOrders();
        displayedOrders = allOrders;
        
        // Update UI
        updateSummaryCards();
        renderOrders(displayedOrders);
        
        hideLoading();
        showOrdersSection();
        
        console.log(`Loaded ${allOrders.length} orders`);
    } catch (error) {
        console.error('Error loading orders:', error);
        hideLoading();
        showError('Failed to load orders. Please try again.');
    }
}

/**
 * Update summary cards
 */
function updateSummaryCards() {
    const todayOrders = orderService.getTodayOrders(allOrders);
    const todayRevenue = orderService.calculateTotalRevenue(todayOrders);
    
    document.getElementById('totalOrders').textContent = allOrders.length;
    document.getElementById('todayOrders').textContent = todayOrders.length;
    document.getElementById('todayRevenue').textContent = `₹${todayRevenue}`;
}

/**
 * Render orders in table
 */
function renderOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');
    const emptyState = document.getElementById('emptyState');
    const displayCount = document.getElementById('displayCount');
    
    // Update count
    displayCount.textContent = `(${orders.length})`;
    
    if (orders.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Build table rows with new column structure including status
    tbody.innerHTML = orders.map(order => {
        const status = order.status || 'Pending';
        const statusClass = `status-${status.toLowerCase()}`;
        return `
        <tr>
            <td class="order-id">${order.orderId || 'N/A'}</td>
            <td class="order-delivery-date">
                <strong>${order.deliveryDate || 'N/A'}</strong>
            </td>
            <td class="order-delivery-time">
                <strong style="color: #43A047;">${order.deliveryTime || 'N/A'}</strong>
            </td>
            <td class="order-address">
                <div><strong>${order.flat || 'N/A'}</strong></div>
                <div style="font-size: 0.9em; color: #636e72;">${order.apartment || 'N/A'}</div>
            </td>
            <td class="order-items">${order.items || 'N/A'}</td>
            <td class="order-total">
                <strong style="color: #43A047;">${order.total || 'N/A'}</strong>
            </td>
            <td class="order-status">
                <span class="status-badge ${statusClass}" onclick="cycleStatus('${order.orderId}', '${status}')" title="Click to change status">
                    ${status}
                </span>
            </td>
            <td class="order-timestamp">
                <div style="font-size: 0.85em; color: #95a5a6;">${formatTimestamp(order.timestamp)}</div>
            </td>
        </tr>
        `;
    }).join('');
}

/**
 * Handle search
 */
function handleSearch(query) {
    if (!query || query.trim() === '') {
        displayedOrders = [...allOrders];
    } else {
        displayedOrders = orderService.searchOrders(allOrders, query);
    }
    
    // Apply current sort
    applySorting();
    renderOrders(displayedOrders);
}

/**
 * Handle sort
 */
function handleSort() {
    applySorting();
    renderOrders(displayedOrders);
}

/**
 * Apply current sorting to displayed orders
 */
function applySorting() {
    if (currentSortBy === 'deliveryTime') {
        displayedOrders = orderService.sortByDeliveryTime(displayedOrders);
    } else {
        // Sort by timestamp (newest first)
        displayedOrders.sort((a, b) => {
            return new Date(b.timestamp) - new Date(a.timestamp);
        });
    }
}

/**
 * Format timestamp
 */
function formatTimestamp(timestamp) {
    if (!timestamp) return 'N/A';
    
    try {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        
        return date.toLocaleDateString('en-IN', { 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return 'Invalid date';
    }
}

/**
 * Show loading state
 */
function showLoading() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('ordersSection').style.display = 'none';
}

/**
 * Hide loading state
 */
function hideLoading() {
    document.getElementById('loadingState').style.display = 'none';
}

/**
 * Show orders section
 */
function showOrdersSection() {
    document.getElementById('ordersSection').style.display = 'block';
}

/**
 * Show error state
 */
function showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('ordersSection').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
}

/**
 * Cycle through status (Pending → Dispatched → Delivered → Pending)
 */
async function cycleStatus(orderId, currentStatus) {
    const statusCycle = {
        'Pending': 'Dispatched',
        'Dispatched': 'Delivered',
        'Delivered': 'Pending'
    };
    
    const newStatus = statusCycle[currentStatus] || 'Pending';
    
    try {
        await updateOrderStatus(orderId, newStatus);
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status. Please try again.');
    }
}

/**
 * Update order status
 */
async function updateOrderStatus(orderId, newStatus) {
    try {
        const config = await loadConfig();
        const webAppUrl = config.googleSheets.webAppUrl;
        
        const response = await fetch(webAppUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'updateStatus',
                orderId: orderId,
                status: newStatus
            })
        });
        
        // Update local order data
        const order = allOrders.find(o => o.orderId === orderId);
        if (order) {
            order.status = newStatus;
        }
        
        // Re-render the current view
        const searchInput = document.getElementById('searchInput');
        if (searchInput && searchInput.value) {
            handleSearch(searchInput.value);
        } else {
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter && statusFilter.value !== 'all') {
                handleStatusFilter(statusFilter.value);
            } else {
                displayedOrders = [...allOrders];
                applySorting();
                renderOrders(displayedOrders);
            }
        }
        
        console.log(`✅ Status updated: ${orderId} → ${newStatus}`);
        
    } catch (error) {
        console.error('Error updating status:', error);
        throw error;
    }
}

/**
 * Handle status filter
 */
function handleStatusFilter(status) {
    if (status === 'all') {
        displayedOrders = [...allOrders];
    } else {
        displayedOrders = allOrders.filter(order => order.status === status);
    }
    
    // Apply current sort
    applySorting();
    renderOrders(displayedOrders);
}

